# 系统架构说明

## 数据流架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          数据生命周期                                  │
└─────────────────────────────────────────────────────────────────────┘

初始化阶段 (只发生一次)
━━━━━━━━━━━━━━━━━━━━━━
┌──────────────────────┐
│ teachers_data_       │
│ final.json           │  ← 初始种子数据
│ (版本控制)            │
└──────────┬───────────┘
           │
           │ python manage.py import_teachers
           ↓
┌──────────────────────┐
│   数据库 (MySQL)      │
│  ✓ 教师表             │
│  ✓ 评价表             │
│  ✓ 用户表             │
└──────────────────────┘


运行时阶段 (持续运行)
━━━━━━━━━━━━━━━━━━━━
┌──────────────────────┐
│   数据库 (MySQL)      │  ← 单一真相源 (Single Source of Truth)
│  ◉ 所有数据存储在这里  │
└──────┬───────────────┘
       │
       │ 读取/写入
       │
┌──────┴───────┬─────────────┬──────────────┐
│              │             │              │
▼              ▼             ▼              ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌──────────┐
│Django  │  │管理端  │  │前端    │  │API      │
│Admin   │  │增删改查 │  │展示    │  │/teachers│
└────────┘  └────────┘  └────────┘  └──────────┘
    │           │           │             │
    └───────────┴───────────┴─────────────┘
                    │
                    │ 所有操作都修改数据库
                    ↓
            ┌──────────────┐
            │  数据库更新   │
            └──────────────┘


备份/导出阶段 (按需执行)
━━━━━━━━━━━━━━━━━━━━━━
┌──────────────────────┐
│   数据库 (MySQL)      │
└──────────┬───────────┘
           │
           │ python manage.py export_teachers
           ↓
┌──────────────────────┐
│ 导出的 JSON 文件      │
│ (用于备份/迁移)       │
└──────────────────────┘
```

## 关键设计决策

### 1. 为什么数据库是单一真相源？

```
优点:
✓ 数据一致性保证
✓ 支持事务和回滚
✓ 并发访问控制
✓ 数据完整性约束
✓ 查询性能优化
✓ 备份和恢复机制

JSON 文件的局限:
✗ 无法处理并发写入
✗ 没有数据完整性约束
✗ 查询性能差
✗ 无事务支持
✗ 容易产生数据不一致
```

### 2. JSON 文件的角色定位

```
┌─────────────────────────────────────────┐
│         JSON 文件的用途                  │
├─────────────────────────────────────────┤
│ ✓ 项目初始化的种子数据                   │
│ ✓ 开发团队共享测试数据集                 │
│ ✓ 版本控制中的示例数据                   │
│ ✓ 数据迁移的临时中间格式                 │
│ ✓ 文档和演示用途                         │
├─────────────────────────────────────────┤
│ ✗ 不是运行时数据存储                     │
│ ✗ 不会自动同步数据库更改                 │
│ ✗ 不适合频繁读写                         │
└─────────────────────────────────────────┘
```

## 协同开发工作流

### 场景对比

#### ❌ 错误的理解

```
开发者 A 在管理端添加教师
         ↓
    期望 JSON 文件自动更新  ← 这不会发生！
         ↓
    git commit JSON 文件
         ↓
    开发者 B 自动获得新数据  ← 实际上不会！
```

#### ✅ 正确的工作流

```
方式 1: 使用数据库迁移 (推荐用于结构变更)
─────────────────────────────────────────
开发者 A 修改 models.py
         ↓
    python manage.py makemigrations
         ↓
    git add migrations/
    git commit
         ↓
    开发者 B git pull
         ↓
    python manage.py migrate
         ↓
    ✓ 数据库结构同步


方式 2: 导出/导入数据 (推荐用于测试数据)
─────────────────────────────────────────
开发者 A 在管理端添加测试教师
         ↓
    python manage.py export_teachers --output test_data.json
         ↓
    git add test_data.json
    git commit
         ↓
    开发者 B git pull
         ↓
    python manage.py import_teachers --json-file test_data.json
         ↓
    ✓ 测试数据同步


方式 3: 数据库备份 (推荐用于生产数据)
─────────────────────────────────────────
生产环境
         ↓
    mysqldump > backup.sql
         ↓
    存储到安全位置
         ↓
    开发环境 mysql < backup.sql
         ↓
    ✓ 完整数据同步
```

## API 交互流程

```
┌─────────────┐
│  前端应用    │
└──────┬──────┘
       │
       │ HTTP 请求
       ↓
┌─────────────────────┐
│  Django REST API    │
│  /api/teachers/     │
└──────┬──────────────┘
       │
       │ ORM 查询
       ↓
┌─────────────────────┐
│     数据库           │
│  Teachers 表         │
└─────────────────────┘

示例:
1. 前端: GET /api/teachers/
2. Django: SELECT * FROM teachers
3. 数据库: 返回数据
4. Django: 序列化为 JSON
5. 前端: 显示教师列表

注意: 整个过程中从不读取 teachers_data_final.json
```

## 环境对比

```
┌────────────────────────────────────────────────────────────┐
│ 开发环境 vs 生产环境                                         │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ 开发环境                      生产环境                      │
│ ─────────                    ─────────                    │
│ • SQLite (db.sqlite3)        • MySQL/PostgreSQL           │
│ • 本地文件系统                • 云存储/专用服务器            │
│ • 测试数据                    • 真实用户数据                │
│ • 可以随意 flush/reset        • 需要严格备份策略             │
│ • JSON 导入/导出用于测试       • 专业数据库备份工具          │
│                                                            │
│ 相同点:                                                     │
│ • 都使用数据库作为数据源                                     │
│ • 都不依赖 JSON 文件进行运行时操作                           │
│ • 都通过 Django ORM 访问数据                                │
└────────────────────────────────────────────────────────────┘
```

## 数据管理命令对照表

| 命令 | 用途 | 何时使用 | 影响范围 |
|------|------|----------|---------|
| `makemigrations` | 创建数据库迁移 | 修改 models.py 后 | 数据库结构 |
| `migrate` | 应用数据库迁移 | 首次设置或更新结构 | 数据库结构 |
| `import_teachers` | 从 JSON 导入数据 | 初始化或恢复数据 | 数据库内容 |
| `export_teachers` | 导出数据到 JSON | 备份或共享测试数据 | 创建 JSON 文件 |
| `createsuperuser` | 创建管理员 | 首次设置 | 用户表 |
| `flush` | 清空数据库 | 重置环境 | ⚠️ 所有数据 |
| `dumpdata` | 导出所有数据 | 完整备份 | 创建 JSON 文件 |
| `loaddata` | 加载 fixture 数据 | 从 fixture 恢复 | 数据库内容 |

## 总结

### 核心原则

1. **数据库优先**: 所有运行时数据操作都针对数据库
2. **JSON 是工具**: 用于初始化、迁移、备份，不是数据源
3. **明确分离**: 开发数据 vs 生产数据，测试 vs 运行时
4. **版本控制**: 提交代码和迁移，不提交数据库文件
5. **自动化**: 使用脚本和命令，而非手动复制数据

### 快速参考

```bash
# 新项目设置
python setup_database.py          # 包含 migrate + import_teachers

# 共享测试数据
python manage.py export_teachers --output team_data.json
git add team_data.json && git commit

# 获取团队数据
git pull
python manage.py import_teachers --json-file team_data.json

# 生产备份
mysqldump -u user -p db_name > backup_$(date +%Y%m%d).sql

# 重置开发环境
python manage.py flush
python manage.py migrate
python manage.py import_teachers
```

### 记住

> **"数据库是真相，JSON 是快照"**
>
> 管理端的修改不会影响 JSON 文件，这是设计的特性，不是 bug。
> 如果需要导出最新数据，使用 `export_teachers` 命令。

